<!DOCTYPE html><html>
<head>
  <title>Dynamic Template Editor</title>
  <style>
    body { font-family: sans-serif; }
    #templateContainer {
      position: relative;
      width: 768px;
      height: 994px;
      border: 1px solid #ccc;
      background-size: cover;
      margin-bottom: 20px;
    }
    .field {
      position: absolute;
      border: 1px dashed #ccc;
      background-color: rgba(255,255,150,0.8);
      padding: 2px;
      font-size: 12px;
      resize: both;
      overflow: auto;
    }
    input[type="text"], textarea {
      width: 200px;
    }
    #previewCanvas {
      display: none;
    }
  </style>
</head>
<body><h3>Step 1: Upload Template Image and Add/Edit Fields</h3>
<input type="file" id="templateInput" accept="image/*"><br>
<button onclick="addBox()">Add Box</button>
<button onclick="saveTemplate()">Save Template</button>
<button onclick="loadTemplate()">Load Saved Template</button><h3>Step 2: Enter Values for Boxes</h3>
<div id="valueInputs"></div>
<button onclick="previewTemplate()">Preview</button>
<button onclick="downloadImage()">Download Image</button><h3>Template Preview</h3>
<div id="templateContainer"></div>
<canvas id="previewCanvas" width="768" height="994"></canvas><script>
let templateImage = new Image();
let boxCounter = 0;
let boxes = [];

function addBox(name = "Box" + (boxCounter+1), top = 50, left = 50, width = 150, height = 20) {
  const id = `box_${boxCounter++}`;
  const box = document.createElement('div');
  box.className = 'field';
  box.contentEditable = true;
  box.style.top = top + 'px';
  box.style.left = left + 'px';
  box.style.width = width + 'px';
  box.style.height = height + 'px';
  box.dataset.name = name;
  box.id = id;
  box.draggable = true;

  makeDraggableResizable(box);
  document.getElementById('templateContainer').appendChild(box);
  boxes.push({ id, name });
}

function makeDraggableResizable(el) {
  el.onmousedown = function(e) {
    const offsetX = e.clientX - el.offsetLeft;
    const offsetY = e.clientY - el.offsetTop;
    function moveAt(e) {
      el.style.left = (e.clientX - offsetX) + 'px';
      el.style.top = (e.clientY - offsetY) + 'px';
    }
    document.onmousemove = moveAt;
    document.onmouseup = () => document.onmousemove = null;
  };
}

document.getElementById('templateInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      templateImage.src = evt.target.result;
      document.getElementById('templateContainer').style.backgroundImage = `url(${evt.target.result})`;
    };
    reader.readAsDataURL(file);
  }
});

function saveTemplate() {
  const fields = Array.from(document.getElementsByClassName('field')).map(box => ({
    id: box.id,
    name: box.dataset.name,
    top: parseInt(box.style.top),
    left: parseInt(box.style.left),
    width: parseInt(box.style.width),
    height: parseInt(box.style.height)
  }));
  localStorage.setItem('savedTemplate', JSON.stringify(fields));
  alert('Template saved!');
}

function loadTemplate() {
  const saved = localStorage.getItem('savedTemplate');
  if (saved) {
    document.getElementById('templateContainer').innerHTML = '';
    boxes = [];
    boxCounter = 0;
    const data = JSON.parse(saved);
    data.forEach(field => addBox(field.name, field.top, field.left, field.width, field.height));
    alert('Template loaded.');
  }
}

function previewTemplate() {
  const container = document.getElementById('valueInputs');
  container.innerHTML = '';
  boxes.forEach(box => {
    const input = document.createElement('input');
    input.placeholder = box.name;
    input.id = `input_${box.id}`;
    container.appendChild(document.createTextNode(box.name + ': '));
    container.appendChild(input);
    container.appendChild(document.createElement('br'));
  });
}

function downloadImage() {
  const canvas = document.getElementById('previewCanvas');
  const ctx = canvas.getContext('2d');

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);

  boxes.forEach(box => {
    const inputVal = document.getElementById(`input_${box.id}`)?.value || '';
    const div = document.getElementById(box.id);
    ctx.font = '12px sans-serif';
    ctx.fillStyle = 'black';
    ctx.fillText(inputVal, parseInt(div.style.left), parseInt(div.style.top) + 12);
  });

  const link = document.createElement('a');
  link.download = 'filled-template.png';
  link.href = canvas.toDataURL();
  link.click();
}
</script></body>
</html>