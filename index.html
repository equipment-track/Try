<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Image Template Editor</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; }
  #imageContainer {
    position: relative;
    display: inline-block;
    border: 1px solid #ccc;
    max-width: 100%;
  }
  #imageContainer img {
    display: block;
    max-width: 100%;
    height: auto;
  }
  .textbox {
    position: absolute;
    min-width: 100px;
    min-height: 30px;
    border: 1px dashed #666;
    background: rgba(255,255,255,0.7);
    resize: none;
    overflow: hidden;
    font-size: 16px;
    padding: 4px;
    cursor: move;
  }
  #controls {
    margin-top: 15px;
  }
  button {
    margin-right: 10px;
  }
</style>
</head>
<body>

<h2>Upload Image and Edit with Text Boxes</h2>

<input type="file" id="imageUploader" accept="image/*" />
<div id="imageContainer"></div>

<div id="controls" style="display:none;">
  <button id="addTextBoxBtn">Add Text Box</button>
  <button id="downloadBtn">Download Image</button>
</div>

<script>
  const imageUploader = document.getElementById('imageUploader');
  const imageContainer = document.getElementById('imageContainer');
  const controls = document.getElementById('controls');
  const addTextBoxBtn = document.getElementById('addTextBoxBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  let imageElement = null;

  // Handle image upload and display
  imageUploader.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      imageContainer.innerHTML = ''; // Clear previous image and textboxes
      imageElement = new Image();
      imageElement.src = event.target.result;
      imageElement.id = 'mainImage';
      imageElement.draggable = false;
      imageElement.style.userSelect = 'none';

      imageElement.onload = () => {
        imageContainer.style.width = imageElement.width + 'px';
        imageContainer.style.height = imageElement.height + 'px';
        imageContainer.appendChild(imageElement);
        controls.style.display = 'block';
      }
    };
    reader.readAsDataURL(file);
  });

  // Add a new draggable textbox
  addTextBoxBtn.addEventListener('click', () => {
    if(!imageElement) return;

    const textbox = document.createElement('textarea');
    textbox.className = 'textbox';
    textbox.style.top = '10px';
    textbox.style.left = '10px';
    textbox.value = 'Edit text';
    textbox.rows = 1;

    makeDraggable(textbox);
    imageContainer.appendChild(textbox);
    textbox.focus();
  });

  // Make element draggable inside the image container
  function makeDraggable(el) {
    let isDragging = false;
    let offsetX, offsetY;

    el.addEventListener('mousedown', (e) => {
      isDragging = true;
      offsetX = e.clientX - el.getBoundingClientRect().left;
      offsetY = e.clientY - el.getBoundingClientRect().top;
      el.style.cursor = 'grabbing';
      e.preventDefault();
    });

    document.addEventListener('mouseup', (e) => {
      isDragging = false;
      if(el) el.style.cursor = 'move';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const containerRect = imageContainer.getBoundingClientRect();
      let left = e.clientX - containerRect.left - offsetX;
      let top = e.clientY - containerRect.top - offsetY;

      // Keep textbox inside image
      left = Math.max(0, Math.min(left, containerRect.width - el.offsetWidth));
      top = Math.max(0, Math.min(top, containerRect.height - el.offsetHeight));
      
      el.style.left = left + 'px';
      el.style.top = top + 'px';
    });
  }

  // Download final image with text overlaid
  downloadBtn.addEventListener('click', () => {
    if (!imageElement) return;

    const canvas = document.createElement('canvas');
    canvas.width = imageElement.naturalWidth;
    canvas.height = imageElement.naturalHeight;
    const ctx = canvas.getContext('2d');

    // Draw base image
    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);

    // Draw each textbox text onto canvas
    const textboxes = imageContainer.querySelectorAll('.textbox');
    textboxes.forEach(textbox => {
      const style = window.getComputedStyle(textbox);
      const fontSize = parseInt(style.fontSize);
      const fontFamily = style.fontFamily;
      const color = style.color || 'black';
      const x = parseInt(textbox.style.left) * (canvas.width / imageElement.width);
      const y = (parseInt(textbox.style.top) + fontSize) * (canvas.height / imageElement.height);
      ctx.font = `${fontSize * (canvas.width / imageElement.width)}px ${fontFamily}`;
      ctx.fillStyle = color;
      const lines = textbox.value.split('\n');
      lines.forEach((line, idx) => {
        ctx.fillText(line, x, y + idx * fontSize * (canvas.height / imageElement.height));
      });
    });

    // Create downloadable link
    const link = document.createElement('a');
    link.download = 'edited-image.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
</script>

</body>
</html>
