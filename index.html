<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mobile-Friendly Image Template Editor</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; }
  #imageContainer {
    position: relative;
    display: inline-block;
    border: 1px solid #ccc;
    max-width: 100%;
    touch-action: none; /* Prevents touch scrolling when dragging */
  }
  #imageContainer img {
    display: block;
    max-width: 100%;
    height: auto;
    user-select: none;
    -webkit-user-drag: none;
  }
  .textbox {
    position: absolute;
    min-width: 100px;
    min-height: 30px;
    border: 1px dashed #666;
    background: rgba(255,255,255,0.7);
    resize: none;
    overflow: hidden;
    font-size: 16px;
    padding: 4px;
    cursor: move;
    user-select: text;
    box-sizing: border-box;
  }
  #controls {
    margin-top: 15px;
  }
  button {
    margin-right: 10px;
    padding: 6px 12px;
    font-size: 14px;
  }
</style>
</head>
<body>

<h2>Upload Image and Edit with Text Boxes</h2>

<input type="file" id="imageUploader" accept="image/*" />
<div id="imageContainer"></div>

<div id="controls" style="display:none;">
  <button id="addTextBoxBtn">Add Text Box</button>
  <button id="downloadBtn">Download Image</button>
</div>

<script>
  const imageUploader = document.getElementById('imageUploader');
  const imageContainer = document.getElementById('imageContainer');
  const controls = document.getElementById('controls');
  const addTextBoxBtn = document.getElementById('addTextBoxBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  let imageElement = null;

  // Handle image upload and display
  imageUploader.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      imageContainer.innerHTML = ''; // Clear previous image and textboxes
      imageElement = new Image();
      imageElement.src = event.target.result;
      imageElement.id = 'mainImage';
      imageElement.draggable = false;
      imageElement.style.userSelect = 'none';

      imageElement.onload = () => {
        // Set fixed pixel dimensions for container to match image natural size for canvas scaling
        imageContainer.style.width = imageElement.width + 'px';
        imageContainer.style.height = imageElement.height + 'px';
        imageContainer.appendChild(imageElement);
        controls.style.display = 'block';
      }
    };
    reader.readAsDataURL(file);
  });

  // Add a new draggable and editable textbox
  addTextBoxBtn.addEventListener('click', () => {
    if(!imageElement) return;

    const textbox = document.createElement('textarea');
    textbox.className = 'textbox';
    textbox.style.top = '10px';
    textbox.style.left = '10px';
    textbox.value = 'Edit text';
    textbox.rows = 1;

    makeDraggable(textbox);
    imageContainer.appendChild(textbox);
    textbox.focus();
  });

  // Make element draggable inside the image container (supports mouse + touch)
  function makeDraggable(el) {
    let isDragging = false;
    let offsetX, offsetY;

    function getClientXY(e) {
      if (e.touches && e.touches.length > 0) {
        return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
      }
      return { clientX: e.clientX, clientY: e.clientY };
    }

    function dragStart(e) {
      // To allow editing text when clicking inside, only start drag if not selecting text
      if (e.target.tagName.toLowerCase() === 'textarea') {
        // If text is selected or cursor inside textarea, don't start drag
        // But we want to allow drag from border or if user is dragging outside text selection
        // Simplify by starting drag only if shift key is pressed (optional)
        if (!e.shiftKey) return;
      }
      const { clientX, clientY } = getClientXY(e);
      isDragging = true;
      offsetX = clientX - el.getBoundingClientRect().left;
      offsetY = clientY - el.getBoundingClientRect().top;
      el.style.cursor = 'grabbing';
      e.preventDefault();
    }

    function dragEnd(e) {
      if(!isDragging) return;
      isDragging = false;
      el.style.cursor = 'move';
    }

    function dragMove(e) {
      if (!isDragging) return;
      const { clientX, clientY } = getClientXY(e);
      const containerRect = imageContainer.getBoundingClientRect();
      let left = clientX - containerRect.left - offsetX;
      let top = clientY - containerRect.top - offsetY;

      // Constrain textbox inside image container boundaries
      left = Math.max(0, Math.min(left, containerRect.width - el.offsetWidth));
      top = Math.max(0, Math.min(top, containerRect.height - el.offsetHeight));

      el.style.left = left + 'px';
      el.style.top = top + 'px';
    }

    // Dragging activates on mousedown or touchstart with shift key for desktop text editing friendliness.
    el.addEventListener('mousedown', dragStart);
    el.addEventListener('touchstart', dragStart, { passive: false });

    document.addEventListener('mouseup', dragEnd);
    document.addEventListener('touchend', dragEnd);

    document.addEventListener('mousemove', dragMove);
    document.addEventListener('touchmove', dragMove, { passive: false });
  }

  // Download final image with text overlaid
  downloadBtn.addEventListener('click', () => {
    if (!imageElement) return;

    const canvas = document.createElement('canvas');
    canvas.width = imageElement.naturalWidth;
    canvas.height = imageElement.naturalHeight;
    const ctx = canvas.getContext('2d');

    // Draw base image
    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);

    // Draw each textbox text onto canvas
    const textboxes = imageContainer.querySelectorAll('.textbox');
    textboxes.forEach(textbox => {
      const style = window.getComputedStyle(textbox);
      const fontSize = parseInt(style.fontSize);
      const fontFamily = style.fontFamily;
      const color = style.color || 'black';
      const lineHeight = fontSize * 1.2;

      // Calculate scaled position on canvas according to image natural size vs displayed size
      const scaleX = canvas.width / imageElement.width;
      const scaleY = canvas.height / imageElement.height;
      const x = parseInt(textbox.style.left) * scaleX;
      const y = (parseInt(textbox.style.top) + fontSize) * scaleY;

      ctx.font = `${fontSize * scaleX}px ${fontFamily}`;
      ctx.fillStyle = color;
      ctx.textBaseline = 'top';

      const lines = textbox.value.split('\n');
      lines.forEach((line, idx) => {
        ctx.fillText(line, x, y + idx * lineHeight * scaleY);
      });
    });

    // Create downloadable link
    const link = document.createElement('a');
    link.download = 'edited-image.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
</script>

</body>
</html>
