<!DOCTYPE html><html>
<head>
  <title>Dynamic Template Editor</title>
  <style>
    body { font-family: sans-serif; }
    #templateContainer {
      position: relative;
      width: 768px;
      height: 994px;
      border: 1px solid #ccc;
      background-size: cover;
      margin-bottom: 20px;
    }
    .field {
      position: absolute;
      border: 1px dashed #000;
      background-color: rgba(255,255,150,0.8);
      padding: 2px;
      font-size: 12px;
      resize: both;
      overflow: auto;
      cursor: move;
    }
    input[type="text"], textarea {
      width: 200px;
    }
    #previewCanvas {
      display: none;
    }
    #templateList {
      margin-top: 10px;
    }
    #templateList button {
      display: block;
      margin: 4px 0;
    }
  </style>
</head>
<body><h3>Step 1: Upload Template Image and Add/Edit Fields</h3>
<input type="file" id="templateInput" accept="image/*"><br><br>
<input type="text" id="templateName" placeholder="Template Name"><br><br>
<button onclick="promptAddBox()">Add Box</button>
<button onclick="saveTemplate()">Save Template</button>
<button onclick="loadTemplateList()">Load Template List</button>
<div id="templateList"></div><h3>Step 2: Enter Values for Boxes</h3>
<div id="valueInputs"></div>
<button onclick="generateInputs()">Generate Inputs</button>
<button onclick="downloadImage()">Download Image</button><h3>Template Preview</h3>
<div id="templateContainer"></div>
<canvas id="previewCanvas" width="768" height="994"></canvas><script>
let templateImage = new Image();
let boxCounter = 0;
let boxes = [];
let currentTemplateKey = '';

function promptAddBox() {
  const name = prompt("Enter Box Label (e.g., Badge No, Name, etc.):");
  if (name) addBox(name);
}

function addBox(name, top = 50, left = 50, width = 150, height = 20) {
  const id = `box_${boxCounter++}`;
  const box = document.createElement('div');
  box.className = 'field';
  box.contentEditable = true;
  box.style.top = top + 'px';
  box.style.left = left + 'px';
  box.style.width = width + 'px';
  box.style.height = height + 'px';
  box.dataset.name = name;
  box.id = id;

  makeDraggable(box);
  document.getElementById('templateContainer').appendChild(box);
  boxes.push({ id, name });
}

function makeDraggable(el) {
  el.onmousedown = function(e) {
    if (e.target !== el) return;
    e.preventDefault();
    const shiftX = e.clientX - el.getBoundingClientRect().left;
    const shiftY = e.clientY - el.getBoundingClientRect().top;

    function moveAt(e) {
      el.style.left = (e.clientX - shiftX) + 'px';
      el.style.top = (e.clientY - shiftY) + 'px';
    }

    document.addEventListener('mousemove', moveAt);
    document.addEventListener('mouseup', function removeEvents() {
      document.removeEventListener('mousemove', moveAt);
      document.removeEventListener('mouseup', removeEvents);
    });
  };
}

document.getElementById('templateInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      templateImage.src = evt.target.result;
      document.getElementById('templateContainer').style.backgroundImage = `url(${evt.target.result})`;
      templateImage.dataset.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  }
});

function saveTemplate() {
  const name = document.getElementById('templateName').value.trim();
  if (!name) return alert("Enter a template name to save.");

  const fields = Array.from(document.getElementsByClassName('field')).map(box => ({
    id: box.id,
    name: box.dataset.name,
    top: parseInt(box.style.top),
    left: parseInt(box.style.left),
    width: parseInt(box.style.width),
    height: parseInt(box.style.height)
  }));

  const templateData = {
    image: templateImage.dataset.src,
    boxes: fields
  };

  localStorage.setItem("template_" + name, JSON.stringify(templateData));
  alert("Template saved!");
}

function loadTemplateList() {
  const container = document.getElementById('templateList');
  container.innerHTML = '<h4>Saved Templates</h4>';
  for (let key in localStorage) {
    if (key.startsWith("template_")) {
      const btn = document.createElement('button');
      btn.textContent = key.replace("template_", "");
      btn.onclick = () => loadTemplate(key);
      container.appendChild(btn);
    }
  }
}

function loadTemplate(key) {
  const data = JSON.parse(localStorage.getItem(key));
  if (!data) return;
  currentTemplateKey = key;
  document.getElementById('templateContainer').innerHTML = '';
  boxes = [];
  boxCounter = 0;
  document.getElementById('templateName').value = key.replace("template_", "");

  templateImage.src = data.image;
  templateImage.onload = () => {
    document.getElementById('templateContainer').style.backgroundImage = `url(${data.image})`;
  };
  templateImage.dataset.src = data.image;

  data.boxes.forEach(box => addBox(box.name, box.top, box.left, box.width, box.height));
  generateInputs();
}

function generateInputs() {
  const container = document.getElementById('valueInputs');
  container.innerHTML = '';
  boxes.forEach(box => {
    const input = document.createElement('input');
    input.placeholder = box.name;
    input.id = `input_${box.id}`;
    container.appendChild(document.createTextNode(box.name + ': '));
    container.appendChild(input);
    container.appendChild(document.createElement('br'));
  });
}

function downloadImage() {
  const canvas = document.getElementById('previewCanvas');
  const ctx = canvas.getContext('2d');

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);

  boxes.forEach(box => {
    const inputVal = document.getElementById(`input_${box.id}`)?.value || '';
    ctx.font = '12px sans-serif';
    ctx.fillStyle = 'black';
    ctx.fillText(inputVal, box.left, box.top + 12);
  });

  const link = document.createElement('a');
  link.download = 'filled-template.png';
  link.href = canvas.toDataURL();
  link.click();
}
</script></body>
</html>