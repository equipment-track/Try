<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Template Box Editor</title>
  <style>
    :root {
      --blue: #276ef1;
      --yellow: #ffd600;
      --red: #ea345e;
      --bg: #f3f6fb;
      --text-primary: #20233a;
      --shadow: 0 8px 24px rgba(34,34,68,0.09);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      max-width: 960px;
      width: 100%;
      background: white;
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 24px 32px 40px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    h2 {
      margin: 0 0 24px;
      color: var(--blue);
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.1em;
    }
    /* Controls panel */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 14px 24px;
      justify-content: center;
    }
    .controls > * {
      min-width: 180px;
      max-width: 280px;
      flex-grow: 1;
      font-size: 1.1em;
      padding: 12px 16px;
      border-radius: 9px;
      border: 1.8px solid #dde4f1;
      background-color: #f7fbff;
      box-shadow: inset 2px 2px 6px #f9fbff, inset -2px -2px 6px #d5dff9;
      transition: all 0.25s ease;
      outline-offset: 3px;
    }
    .controls > *:focus {
      border-color: var(--blue);
      background-color: white;
      box-shadow: 0 0 10px var(--blue);
      outline: none;
    }
    button {
      background: var(--blue);
      color: white;
      font-weight: 700;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 14px #276ef130;
      transition: background-color 0.3s, transform 0.2s ease;
      user-select: none;
    }
    button:hover,
    button:focus {
      background-color: #154ecb;
      transform: translateY(-2px) scale(1.06);
      outline: none;
    }
    input[type='file'] {
      cursor: pointer;
      padding: 8px 12px;
    }
    /* Inputs container */
    #inputFields {
      max-height: 200px;
      overflow-y: auto;
      background: #e1e8ff;
      box-shadow: inset 1px 1px 6px #bcc9f91c;
      border-radius: 12px;
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      border: 1.5px solid #cedeff;
    }
    #inputFields .input-wrapper {
      display: flex;
      flex-direction: column;
    }
    #inputFields label {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--blue);
      user-select:none;
    }
    #inputFields input[type='text'] {
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1.8px solid #a9b9d6;
      transition: border-color 0.3s ease;
      outline-offset: 3px;
    }
    #inputFields input[type='text']:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 9px var(--blue);
      background: white;
    }
    /* Image / preview canvas container */
    #previewContainer {
      position: relative;
      border-radius: 14px;
      border: 3px solid #c0cbed;
      max-width: 100%;
      max-height: 500px;
      overflow: auto;
      user-select: none;
      background: #f0f4ff;
      box-shadow: inset 0 0 24px #adc6f630;
      align-self: center;
    }
    canvas {
      display: block;
      border-radius: 12px;
      max-width: 100%;
      max-height: 600px;
      margin: auto;
      background-color: white;
      touch-action: none;
    }
    /* Draggable boxes */
    .highlight-box {
      position: absolute;
      border: 2.7px dashed var(--yellow);
      background: rgba(255, 210, 10, 0.15);
      min-width: 60px;
      min-height: 26px;
      padding: 6px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      color: #333;
      box-shadow: 0 2px 18px 0 #ffd600b0;
      resize: both;
      overflow: auto;
      cursor: move;
      user-select: none;
      z-index: 9;
      transition: border-color 0.25s, box-shadow 0.25s, background-color 0.25s;
    }
    .highlight-box.selected {
      border-color: var(--blue);
      background: #b2d0ff6a;
      box-shadow: 0 0 35px 4px #276ef1aa;
      cursor: grabbing;
      z-index: 99;
    }
    .highlight-box .drag-handle {
      position: absolute;
      top: -22px;
      left: 0;
      background: var(--yellow);
      padding: 5px 10px 6px;
      border-radius: 10px 10px 10px 0;
      font-weight: 700;
      color: black;
      font-size: 13px;
      box-shadow: 0 3px 14px #ffd600bb;
      cursor: grab;
      user-select:none;
      transition: background-color 0.3s ease;
      z-index: 10;
    }
    .highlight-box .drag-handle:active {
      background: var(--blue);
      color: white;
      cursor: grabbing;
    }
    /* Buttons container below inputs */
    .buttons-row {
      display: flex;
      justify-content: center;
      gap: 22px;
      flex-wrap: wrap;
      margin-top: 14px;
      margin-bottom: 4px;
    }
    .btn-main {
      font-size: 1.17em;
      font-weight: 700;
      border-radius: 12px;
      border: none;
      padding: 16px 38px;
      background: var(--blue);
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 22px #276ef144;
      transition: background-color 0.25s, transform 0.22s ease;
      user-select: none;
      min-width: 180px;
    }
    .btn-main:hover,
    .btn-main:focus {
      background: #123dbf;
      transform: translateY(-3px) scale(1.05);
      outline: none;
    }

    /* Template list */
    .template-list {
      max-height: 160px;
      overflow-y: auto;
      background: #f1f6ff;
      border-radius: 12px;
      padding: 10px 24px;
      box-shadow: inset 0 0 26px #a6baff2a;
      font-weight: 600;
      border: 1.5px solid #bed4ff;
    }
    .template-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      color: var(--blue);
      cursor: default;
      user-select:none;
      border-radius: 7px;
      padding: 6px 14px;
      transition: background-color 0.21s ease;
    }
    .template-item:hover {
      background: #dbe5f6;
    }
    .template-item span {
      font-weight: 700;
    }
    .template-item button {
      min-width: 70px;
      padding: 6px 14px;
      border-radius: 10px;
      border: none;
      user-select:none;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      color: white;
    }
    .template-item button.loadBtn {
      background-color: var(--blue);
      margin-right: 8px;
    }
    .template-item button.loadBtn:hover {
      background-color: #0a3a9f;
    }
    .template-item button.delBtn {
      background-color: var(--red);
    }
    .template-item button.delBtn:hover {
      background-color: #a01e31;
    }

  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Template Box Editor"):
    <h2>Template Box Editor</h2>

    <div class="controls" role="region" aria-label="Control Panel">
      <input type="file" id="imageUpload" accept="image/*" aria-label="Upload Image" />
      <input type="text" id="boxName" placeholder="Box Name" aria-label="Box Name Input" autocomplete="off" />
      <button id="addBoxBtn" aria-label="Add Box Button">Add Box</button>
      <input type="text" id="templateName" placeholder="Template Name" aria-label="Template Name Input" autocomplete="off" />
      <button id="saveTemplateBtn" aria-label="Save Template Button">Save Template</button>
      <button id="loadTemplatesBtn" aria-label="Load Templates Button">Load Templates</button>
    </div>

    <div id="inputFields" role="form" aria-label="Box Text Inputs" tabindex="0">
      <!-- Dynamically generated inputs per box -->
    </div>

    <div id="previewContainer" aria-label="Image Preview Panel" tabindex="0">
      <canvas id="templateCanvas" width="0" height="0"></canvas>
    </div>

    <div class="buttons-row" role="region" aria-label="Action Buttons">
      <button class="btn-main" id="generateTextBtn" aria-label="Generate Text Button">Generate Text</button>
      <button class="btn-main" id="downloadBtn" aria-label="Download Image Button">Download</button>
    </div>

    <div class="template-list" id="templateList" aria-label="Saved Templates List"></div>
  </div>

  <script>
    (() => {
      const imageUpload = document.getElementById('imageUpload');
      const boxNameInput = document.getElementById('boxName');
      const addBoxBtn = document.getElementById('addBoxBtn');
      const templateNameInput = document.getElementById('templateName');
      const saveTemplateBtn = document.getElementById('saveTemplateBtn');
      const loadTemplatesBtn = document.getElementById('loadTemplatesBtn');
      const inputFields = document.getElementById('inputFields');
      const templateList = document.getElementById('templateList');
      const generateTextBtn = document.getElementById('generateTextBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const canvas = document.getElementById('templateCanvas');
      const ctx = canvas.getContext('2d');

      let image = new Image();
      let boxes = [];

      // Helper: show toast
      function showToast(msg) {
        const existingToast = document.getElementById('toastMessage');
        if(existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.id = 'toastMessage';
        Object.assign(toast.style, {
          position: 'fixed',
          bottom: '24px',
          left: '50%',
          transform: 'translateX(-50%)',
          backgroundColor: 'var(--blue)',
          color: 'white',
          padding: '14px 28px',
          borderRadius: '20px',
          fontWeight: '600',
          fontSize: '1.1em',
          boxShadow: '0 6px 18px var(--blue)',
          userSelect: 'none',
          opacity: '0',
          transition: 'opacity 0.3s ease',
          zIndex: '10000',
        });
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => (toast.style.opacity = '1'), 30);
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 400);
        }, 2000);
      }

      // Resize canvas and redraw image & boxes
      function resizeCanvasToImage() {
        canvas.width = image.width;
        canvas.height = image.height;
        drawCanvas();
      }

      // Draw image and boxes with inputted text
      function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0);
        boxes.forEach(box => {
          const input = inputFields.querySelector(`input[data-name="${box.name}"]`);
          if(!input) return;
          const text = input.value.trim();
          if(!text) return;

          ctx.save();
          ctx.textBaseline = 'top';
          ctx.fillStyle = '#222';
          // Adaptive font size:
          let fontSize = 18;
          ctx.font = `${fontSize}px Segoe UI, Arial`;
          const maxWidth = box.width - 8;
          while(fontSize > 10 && ctx.measureText(text).width > maxWidth) {
            fontSize--;
            ctx.font = `${fontSize}px Segoe UI, Arial`;
          }
          ctx.fillText(text, box.left + 4, box.top + 4);
          ctx.restore();

          // Draw dashed box boundary
          ctx.save();
          ctx.strokeStyle = 'yellow';
          ctx.lineWidth = 2.7;
          ctx.setLineDash([5, 5]);
          ctx.strokeRect(box.left, box.top, box.width, box.height);
          ctx.restore();
        });
      }

      // Update inputs dynamically from boxes array
      function updateInputFields() {
        inputFields.innerHTML = '';
        if(boxes.length === 0) {
          inputFields.textContent = 'Add boxes to enter text here.';
          return;
        }
        boxes.forEach(box => {
          const wrapper = document.createElement('div');
          wrapper.className = 'input-wrapper';
          const label = document.createElement('label');
          label.textContent = box.name;
          label.htmlFor = 'input-' + box.name;
          const input = document.createElement('input');
          input.type = 'text';
          input.id = 'input-' + box.name;
          input.dataset.name = box.name;
          input.placeholder = `Enter text for '${box.name}'`;
          input.addEventListener('input', () => drawCanvas());
          wrapper.appendChild(label);
          wrapper.appendChild(input);
          inputFields.appendChild(wrapper);
        });
      }

      // Clear everything (boxes, canvas, inputs)
      function clearAll() {
        boxes = [];
        updateInputFields();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.width = 0;
        canvas.height = 0;
      }

      // Load image to preview
      function loadImage(src) {
        image = new Image();
        image.onload = () => {
          resizeCanvasToImage();
          updateInputFields();
          showToast('Image loaded.');
        };
        image.src = src;
      }

      // Add a new box
      function addBox() {
        const name = boxNameInput.value.trim();
        if(!name) {
          showToast('Enter box name.');
          return;
        }
        if(boxes.find(b => b.name.toLowerCase() === name.toLowerCase())) {
          showToast('Box name must be unique.');
          return;
        }
        if(!image.src) {
          showToast('Upload image first.');
          return;
        }
        boxes.push({ name, left: 40, top: 40, width: 140, height: 50 });
        updateInputFields();
        drawCanvas();
        boxNameInput.value = '';
        showToast(`Box '${name}' added.`);
      }

      // Save template to localStorage
      function saveTemplate() {
        const name = templateNameInput.value.trim();
        if(!name) {
          showToast('Enter template name.');
          return;
        }
        if(!image.src) {
          showToast('Upload image first.');
          return;
        }
        const data = { imageURL: image.src, boxes };
        localStorage.setItem('template_' + name, JSON.stringify(data));
        showToast(`Template '${name}' saved.`);
        loadTemplates();
      }

      // Load all templates and display
      function loadTemplates() {
        templateList.innerHTML = '';
        const keys = Object.keys(localStorage).filter(k => k.startsWith('template_'));
        if(!keys.length) {
          templateList.textContent = 'No saved templates.';
          return;
        }
        keys.forEach(key => {
          const name = key.substring(9);
          const div = document.createElement('div');
          div.className = 'template-item';

          const span = document.createElement('span');
          span.textContent = name;

          const loadBtn = document.createElement('button');
          loadBtn.textContent = 'Load';
          loadBtn.className = 'loadBtn';
          loadBtn.onclick = () => {
            const data = JSON.parse(localStorage.getItem(key));
            boxes = data.boxes || [];
            loadImage(data.imageURL);
            templateNameInput.value = name;
            updateInputFields();
            drawCanvas();
            showToast(`Loaded template '${name}'.`);
          };

          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.className = 'delBtn';
          delBtn.onclick = () => {
            if(confirm(`Delete template '${name}'?`)) {
              localStorage.removeItem(key);
              loadTemplates();
              showToast(`Template '${name}' deleted.`);
              if(templateNameInput.value === name) {
                clearAll();
                templateNameInput.value = '';
              }
            }
          };

          div.appendChild(span);
          div.appendChild(loadBtn);
          div.appendChild(delBtn);
          templateList.appendChild(div);
        });
      }

      // Generate Text button handler
      function generateText() {
        if(!image.src) {
          showToast('Upload an image first.');
          return;
        }
        if(boxes.length === 0) {
          showToast('Add at least one box.');
          return;
        }
        drawCanvas();
        showToast('Text drawn on image.');
      }

      // Download button
      function download() {
        if(!canvas.width || !canvas.height) {
          showToast('Generate text first.');
          return;
        }
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = 'template_output.png';
        link.click();
        showToast('Image downloaded.');
      }

      // Initialize event listeners
      imageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => loadImage(ev.target.result);
        reader.readAsDataURL(file);
        clearAll();
      });
      addBoxBtn.addEventListener('click', addBox);
      saveTemplateBtn.addEventListener('click', saveTemplate);
      loadTemplatesBtn.addEventListener('click', loadTemplates);
      generateTextBtn.addEventListener('click', generateText);
      downloadBtn.addEventListener('click', download);

      // Initial load templates display
      window.addEventListener('load', loadTemplates);
    })();
  </script>
</body>
</html>
