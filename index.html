<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Image Text Box Editor</title>
<style>
  body {
    margin: 0; font-family: Arial, sans-serif;
    background: #f0f0f0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
  }
  .container {
    margin: 20px;
    background: white; padding: 16px;
    border-radius: 8px;
    max-width: 900px;
    width: 100%;
  }
  #controls {
    margin-bottom: 10px;
    display: flex; gap: 10px; flex-wrap: wrap;
  }
  input[type="file"], input[type="text"], button {
    padding: 8px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;
  }
  button {
    cursor: pointer;
    background: #007bff;
    color: white;
    border: none;
  }
  button:hover {
    background: #0056b3;
  }
  #inputFields {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap: 8px;
    max-height: 180px;
    overflow-y: auto;
    margin-bottom: 10px;
  }
  .input-wrapper label {
    font-weight: bold;
    display: block;
    margin-bottom: 4px;
  }
  .input-wrapper textarea {
    width: 100%;
    height: 50px;
    resize: vertical;
    font-size: 1em;
  }
  #previewContainer {
    position: relative;
    border: 2px solid #ccc;
    width: 100%;
    max-height: 500px;
    overflow: auto;
  }
  canvas {
    display: block;
    max-width: 100%;
    border-radius: 6px;
    background: white;
  }
  .box-overlay {
    position: absolute;
    border: 2px dashed #007bff;
    background: rgba(0, 123, 255, 0.15);
    border-radius: 6px;
    cursor: move;
    user-select: none;
  }
  .resize-handle {
    position: absolute;
    width: 14px;
    height: 14px;
    background: #007bff;
    border-radius: 50%;
    right: -7px;
    bottom: -7px;
    cursor: nwse-resize;
  }
</style>
</head>
<body>
  <div class="container">
    <div id="controls">
      <input type="file" id="imageUpload" accept="image/*" />
      <input type="text" id="boxName" placeholder="Box Name" />
      <button id="addBoxBtn">Add Box</button>
    </div>
    <div id="inputFields" aria-label="Box text inputs"></div>
    <div id="previewContainer">
      <canvas id="templateCanvas"></canvas>
    </div>
  </div>

<script>
(() => {
  const imageUpload = document.getElementById('imageUpload');
  const boxNameInput = document.getElementById('boxName');
  const addBoxBtn = document.getElementById('addBoxBtn');
  const inputFields = document.getElementById('inputFields');
  const previewContainer = document.getElementById('previewContainer');
  const canvas = document.getElementById('templateCanvas');
  const ctx = canvas.getContext('2d');

  let image = new Image();
  let boxes = [];
  let selectedBox = null;

  function drawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!image.src) return;
    ctx.drawImage(image, 0, 0);

    boxes.forEach(box => {
      ctx.save();
      ctx.translate(box.left, box.top);
      ctx.beginPath();
      ctx.rect(0, 0, box.width, box.height);
      ctx.clip();

      ctx.fillStyle = 'black';
      ctx.font = '16px Arial';
      ctx.textBaseline = 'top';
      ctx.textAlign = 'left';

      const padding = 6;
      const lines = (box.text || '').split('\n');
      const lineHeight = 18;

      for(let i=0; i < lines.length; i++) {
        const y = padding + i * lineHeight;
        if (y + lineHeight > box.height - padding) break;
        ctx.fillText(lines[i], padding, y);
      }

      ctx.restore();
    });
  }

  function createBoxOverlays() {
    // Remove existing overlays
    document.querySelectorAll('.box-overlay').forEach(el => el.remove());

    boxes.forEach(box => {
      const el = document.createElement('div');
      el.className = 'box-overlay';
      el.style.left = box.left + 'px';
      el.style.top = box.top + 'px';
      el.style.width = box.width + 'px';
      el.style.height = box.height + 'px';
      el.dataset.name = box.name;

      // Drag logic
      let dragStartX, dragStartY, boxStartL, boxStartT, dragging = false;

      el.addEventListener('mousedown', e => {
        if (e.target.classList.contains('resize-handle')) return;
        dragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        boxStartL = box.left;
        boxStartT = box.top;
        el.style.zIndex = 1000;
        e.preventDefault();
      });

      window.addEventListener('mousemove', e => {
        if (!dragging) return;
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        box.left = Math.min(Math.max(0, boxStartL + dx), canvas.width - box.width);
        box.top = Math.min(Math.max(0, boxStartT + dy), canvas.height - box.height);
        el.style.left = box.left + 'px';
        el.style.top = box.top + 'px';
        drawCanvas();
      });

      window.addEventListener('mouseup', e => {
        if (dragging) {
          dragging = false;
          el.style.zIndex = '';
          drawCanvas();
        }
      });

      // Resize handle
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle';

      let resizing = false, resizeStartX, resizeStartY, boxStartW, boxStartH;

      resizeHandle.addEventListener('mousedown', e => {
        resizing = true;
        resizeStartX = e.clientX;
        resizeStartY = e.clientY;
        boxStartW = box.width;
        boxStartH = box.height;
        el.style.zIndex = 1000;
        e.preventDefault();
        e.stopPropagation();
      });

      window.addEventListener('mousemove', e => {
        if(!resizing) return;
        let dw = e.clientX - resizeStartX;
        let dh = e.clientY - resizeStartY;
        box.width = Math.min(Math.max(40, boxStartW + dw), canvas.width - box.left);
        box.height = Math.min(Math.max(20, boxStartH + dh), canvas.height - box.top);
        el.style.width = box.width + 'px';
        el.style.height = box.height + 'px';
        drawCanvas();
      });

      window.addEventListener('mouseup', e => {
        if(resizing) {
          resizing = false;
          el.style.zIndex = '';
          drawCanvas();
        }
      });

      el.appendChild(resizeHandle);

      inputFields.querySelectorAll('textarea').forEach(ta => {
        if (ta.dataset.name === box.name) {
          ta.value = box.text || '';
        }
      });

      el.addEventListener('click', () => {
        selectedBox = box;
        updateInputFocus();
      });

      previewContainer.appendChild(el);
    });
  }

  function updateInputFields() {
    inputFields.innerHTML = '';
    if (boxes.length === 0) {
      inputFields.textContent = 'Add boxes to enter text here.';
      return;
    }

    boxes.forEach(box => {
      const wrapper = document.createElement('div');
      wrapper.className = 'input-wrapper';
      const label = document.createElement('label');
      label.textContent = box.name;
      label.htmlFor = 'input-' + box.name;
      const textarea = document.createElement('textarea');
      textarea.id = 'input-' + box.name;
      textarea.dataset.name = box.name;
      textarea.value = box.text || '';
      textarea.placeholder = `Text for "${box.name}"`;

      textarea.addEventListener('input', e => {
        const currentBox = boxes.find(b => b.name === textarea.dataset.name);
        if (currentBox) {
          currentBox.text = textarea.value;
          drawCanvas();
        }
      });

      wrapper.appendChild(label);
      wrapper.appendChild(textarea);
      inputFields.appendChild(wrapper);
    });
  }

  function updateInputFocus() {
    const focusedName = selectedBox ? selectedBox.name : null;
    inputFields.querySelectorAll('textarea').forEach(ta => {
      if (ta.dataset.name === focusedName) {
        ta.focus();
      }
    });
  }

  imageUpload.addEventListener('change', () => {
    const file = imageUpload.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      image.src = e.target.result;
      image.onload = () => {
        canvas.width = image.width;
        canvas.height = image.height;
        boxes = [];
        inputFields.innerHTML = '';
        createBoxOverlays();
        drawCanvas();
      };
    };
    reader.readAsDataURL(file);
  });

  addBoxBtn.addEventListener('click', () => {
    const name = boxNameInput.value.trim();
    if (!name) {
      alert('Please enter a box name');
      return;
    }
    if (boxes.some(b => b.name.toLowerCase() === name.toLowerCase())) {
      alert('Box name must be unique');
      return;
    }
    if (!image.src) {
      alert('Please upload an image first');
      return;
    }
    boxes.push({
      name,
      left: 50,
      top: 50,
      width: 150,
      height: 50,
      text: ''
    });
    boxNameInput.value = '';
    createBoxOverlays();
    updateInputFields();
    drawCanvas();
  });
})();
</script>
</body>
</html>
