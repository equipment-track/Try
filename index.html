<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced Template Box Editor</title>
  <style>
    :root {
      --blue: #276ef1;
      --yellow: #ffd600;
      --red: #ea345e;
      --shadow: 0 8px 24px rgba(34,34,68,0.09);
      --bg: #f3f6fb;
      --text-primary: #20233a;
    }
    body {
      margin:0; padding:20px;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: 980px;
      background: white;
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 24px 34px 48px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    h2 {
      color: var(--blue);
      font-weight: 700;
      letter-spacing: 0.1em;
      margin: 0 0 14px 0;
      text-align: center;
    }
    /* CONTROLS */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px 24px;
      justify-content: center;
    }
    .controls > * {
      min-width: 180px;
      flex-grow: 1;
      max-width: 290px;
      font-size: 1.1em;
      padding: 11px 16px;
      border-radius: 10px;
      border: 1.8px solid #dde4f1;
      box-shadow: inset 2px 2px 6px #f9fbff, inset -2px -2px 6px #d5dff9;
      background-color: #f7fbff;
      transition: all 0.25s ease;
      outline-offset: 3px;
    }
    .controls > *:focus {
      border-color: var(--blue);
      box-shadow: 0 0 12px var(--blue);
      background-color: white;
    }
    button {
      background-color: var(--blue);
      color: white;
      font-weight: 700;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 14px #276ef130;
      transition: background-color 0.3s, transform 0.2s ease;
      user-select:none;
    }
    button:hover, button:focus {
      background-color: #154ecb;
      transform: translateY(-2px) scale(1.06);
      outline: none;
    }
    input[type="file"] {
      cursor: pointer;
      padding: 8px 12px;
    }
    /* INPUTS dynamic */
    #inputFields {
      max-height: 190px;
      overflow-y: auto;
      background: #e1e8ff;
      box-shadow: inset 1px 1px 6px #bcc9f91c;
      border-radius: 12px;
      padding: 16px 28px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 28px;
    }
    #inputFields .input-wrapper {
      display: flex;
      flex-direction: column;
      font-weight: 600;
    }
    #inputFields label {
      margin-bottom: 6px;
      color: var(--blue);
      font-size: 1rem;
      user-select:none;
    }
    #inputFields input[type="text"] {
      padding: 8px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1.8px solid #a9b9d6;
      background: white;
      transition: border-color 0.25s ease;
    }
    #inputFields input[type="text"]:focus {
      border-color: var(--blue);
      outline: none;
      box-shadow: 0 0 10px var(--blue);
    }
    /* Template preview */
    #templateArea {
      position: relative;
      border-radius: 14px;
      border: 3px solid #c0cbed;
      max-width: 100%;
      overflow: auto;
      user-select: none;
      background: #f0f4ff;
      box-shadow: inset 0 0 22px #adc6f61a;
      align-self: center;
    }
    #templateArea img {
      display: block;
      max-width: 100%;
      border-radius: 12px;
      pointer-events: none;
      user-select:none;
    }
    /* Boxes */
    .highlight-box {
      position: absolute;
      border: 2.7px dashed var(--yellow);
      background: rgba(255, 210, 10, 0.15);
      border-radius: 10px;
      cursor: move;
      user-select: none;
      min-width: 60px;
      min-height: 28px;
      padding: 6px 10px;
      font-weight: 700;
      font-size: 14px;
      color: #333;
      box-shadow: 0 2px 18px 0 #ffd60088;
      resize: both;
      overflow: auto;
      transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
      z-index: 9;
    }
    .highlight-box.selected {
      border-color: var(--blue);
      background: #b2d0ff6a;
      box-shadow: 0 0 30px 3px #276ef166;
      z-index: 99;
      cursor: grabbing;
    }
    .highlight-box .drag-handle {
      position: absolute;
      top: -20px;
      left: 0;
      background: var(--yellow);
      padding: 4px 8px;
      border-radius: 8px 8px 8px 0;
      font-weight: 700;
      color: #1b1b1b;
      font-size: 13px;
      cursor: grab;
      box-shadow: 0 2px 12px #ffd60077;
      user-select:none;
      z-index: 100;
      transition: background-color 0.3s ease;
    }
    .highlight-box .drag-handle:active {
      cursor: grabbing;
      background: var(--blue);
      color: white;
    }
    /* Canvas */
    #outputCanvas {
      margin-top: 18px;
      border-radius: 14px;
      border: 2px solid #a9bbf3;
      box-shadow: 0 6px 22px #276ef144;
      max-width: 100%;
      user-select:none;
      display: block;
    }
    /* Bottom buttons */
    .bottom-buttons {
      display: flex;
      gap: 18px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .btn-main {
      font-size: 1.15em;
      font-weight: 700;
      border-radius: 12px;
      border: none;
      padding: 16px 32px;
      background: var(--blue);
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 22px #276ef144;
      transition: background-color 0.25s, transform 0.22s;
      user-select: none;
      min-width: 180px;
    }
    .btn-main:hover, .btn-main:focus {
      background: #123dbf;
      transform: translateY(-3px) scale(1.05);
      outline: none;
    }
    /* Template list */
    .template-list {
      max-height: 180px;
      overflow-y: auto;
      background: #f1f6ff;
      border-radius: 12px;
      padding: 10px 22px;
      box-shadow: inset 0 0 26px #a6baff2a;
      font-weight: 600;
      border: 1.5px solid #bed4ff;
    }
    .template-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      color: var(--blue);
      cursor: default;
      user-select:none;
      border-radius: 7px;
      padding: 5px 12px;
      transition: background-color 0.21s ease;
    }
    .template-item:hover {
      background: #dbe5f6;
    }
    .template-item span {
      font-weight: 700;
    }
    .template-item button {
      min-width: 70px;
      padding: 6px 14px;
      border-radius: 10px;
      border: none;
      user-select:none;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      color: white;
    }
    .template-item button.loadBtn {
      background-color: var(--blue);
      margin-right: 8px;
    }
    .template-item button.loadBtn:hover {
      background-color: #0a3a9f;
    }
    .template-item button.delBtn {
      background-color: var(--red);
    }
    .template-item button.delBtn:hover {
      background-color: #a01e31;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(30, 40, 70, 0.28);
      backdrop-filter: blur(3px);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal.show {
      display: flex;
      animation: fadeIn 0.33s forwards;
    }
    @keyframes fadeIn {
      from {opacity:0;}
      to {opacity:1;}
    }
    .modal-content {
      background: white;
      border-radius: 18px;
      max-width: 320px;
      width: 86vw;
      padding: 26px 28px 32px;
      text-align: center;
      box-shadow: 0 10px 40px rgb(0 0 0 / 0.25);
      user-select:none;
      font-weight: 600;
      color: var(--blue);
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 18px;
      font-weight: 700;
      font-size: 1.7em;
      color:#555;
      cursor: pointer;
      user-select:none;
      transition: color 0.3s ease;
    }
    .modal-close:hover {
      color: var(--red);
    }
    .modal-content p {
      margin: 14px 0 26px 0;
      font-size: 1.15em;
      font-weight: 500;
      color: var(--text-primary);
    }
    .modal-buttons button {
      border-radius: 12px;
      padding: 16px 34px;
      border: none;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      user-select:none;
      margin: 0 12px;
      min-width: 120px;
      transition: background-color 0.3s ease;
    }
    .modal-buttons button.confirm {
      background: var(--red);
      color: white;
      box-shadow: 0 4px 12px #ea345e9c;
    }
    .modal-buttons button.confirm:hover {
      background: #a71a37;
    }
    .modal-buttons button.cancel {
      background: var(--blue);
      color: white;
      box-shadow: 0 4px 12px #276ef166;
    }
    .modal-buttons button.cancel:hover {
      background: #0e3ea9;
    }
    /* Scrollbar for inputs and template list */
    #inputFields::-webkit-scrollbar,
    .template-list::-webkit-scrollbar {
      width: 7px;
    }
    #inputFields::-webkit-scrollbar-thumb,
    .template-list::-webkit-scrollbar-thumb {
      background-color: var(--blue);
      border-radius: 20px;
    }
    /* Responsive */
    @media (max-width: 770px) {
      #inputFields {
        grid-template-columns: 1fr;
      }
      .controls {
        flex-direction: column;
        align-items: center;
      }
      .controls > * {
        max-width: 96vw;
      }
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Template Box Editor">

    <h2>Template Box Editor</h2>

    <div class="controls" role="region" aria-label="Control Panel">
      <input type="file" id="imageUpload" accept="image/*" aria-label="Upload Template Image" />
      <input type="text" id="boxName" placeholder="Box Name" aria-label="New Box Name" autocomplete="off" />
      <button id="addBoxBtn" aria-label="Add Box Button">Add Box</button>
      <input type="text" id="templateName" placeholder="Template Name" aria-label="Template Name" autocomplete="off" />
      <button id="saveTemplateBtn" aria-label="Save Template Button">Save Template</button>
      <button id="loadTemplatesBtn" aria-label="Load Templates Button">Load Templates</button>
    </div>

    <div id="inputFields" role="form" aria-label="Box Text Inputs" tabindex="0">
      <!-- Input fields dynamically generated -->
    </div>

    <div id="templateArea" aria-label="Image Preview with Boxes" tabindex="0"></div>

    <canvas id="outputCanvas" aria-label="Output Canvas with Text Overlay"></canvas>

    <div class="bottom-buttons">
      <button class="btn-main" id="generateTextBtn" aria-label="Generate Text Button">Generate Text</button>
      <button class="btn-main" id="downloadBtn" aria-label="Download Image Button">Download</button>
    </div>

    <div class="template-list" id="templateList" aria-label="Saved Templates List"></div>
  </div>

  <div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessage" tabindex="-1">
    <div class="modal-content">
      <span class="modal-close" role="button" aria-label="Close Modal Button" tabindex="0">&times;</span>
      <p id="modalMessage"></p>
      <div class="modal-buttons">
        <button class="confirm" id="confirmDeleteBtn">Delete</button>
        <button class="cancel" id="cancelDeleteBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ========== Classes ==========

    // Represents one box overlay on the template image
    class Box {
      constructor(name, left = 20, top = 20, width = 140, height = 50) {
        this.name = name;
        this.left = left;
        this.top = top;
        this.width = width;
        this.height = height;
      }
      toJSON() {
        return {
          name: this.name,
          left: this.left,
          top: this.top,
          width: this.width,
          height: this.height
        };
      }
    }

    // Manages template information and stored templates
    class TemplateManager {
      constructor() {
        this.currentTemplate = {
          imageURL: '',
          boxes: []
        };
      }
      setImageURL(url) {
        this.currentTemplate.imageURL = url;
      }
      addBox(box) {
        if (this.currentTemplate.boxes.some(b => b.name.toLowerCase() === box.name.toLowerCase())) {
          throw new Error("Box name must be unique");
        }
        this.currentTemplate.boxes.push(box);
      }
      updateBox(updatedBox) {
        const idx = this.currentTemplate.boxes.findIndex(b => b.name === updatedBox.name);
        if (idx >= 0) this.currentTemplate.boxes[idx] = updatedBox;
      }
      removeBox(name) {
        this.currentTemplate.boxes = this.currentTemplate.boxes.filter(b => b.name !== name);
      }
      saveTemplate(name) {
        if (!name) throw new Error("Template name is required");
        localStorage.setItem('template_' + name, JSON.stringify(this.currentTemplate));
      }
      loadTemplate(name) {
        const jsonStr = localStorage.getItem('template_' + name);
        if (!jsonStr) throw new Error("Template not found");
        this.currentTemplate = JSON.parse(jsonStr);
        return this.currentTemplate;
      }
      listTemplates() {
        return Object.keys(localStorage).filter(key => key.startsWith('template_')).map(key => key.substring(9));
      }
      deleteTemplate(name) {
        localStorage.removeItem('template_' + name);
      }
    }

    // UI controller handling rendering and events
    class UIController {
      constructor() {
        // Elements
        this.templateArea = document.getElementById('templateArea');
        this.inputFields = document.getElementById('inputFields');
        this.templateList = document.getElementById('templateList');
        this.outputCanvas = document.getElementById('outputCanvas');
        this.ctx = this.outputCanvas.getContext('2d');
        this.imageUpload = document.getElementById('imageUpload');
        this.boxNameInput = document.getElementById('boxName');
        this.templateNameInput = document.getElementById('templateName');
        this.addBoxBtn = document.getElementById('addBoxBtn');
        this.saveTemplateBtn = document.getElementById('saveTemplateBtn');
        this.loadTemplatesBtn = document.getElementById('loadTemplatesBtn');
        this.generateTextBtn = document.getElementById('generateTextBtn');
        this.downloadBtn = document.getElementById('downloadBtn');

        // Modal elements
        this.deleteModal = document.getElementById('deleteModal');
        this.modalMessage = document.getElementById('modalMessage');
        this.confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        this.cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        this.modalCloseBtn = this.deleteModal.querySelector('.modal-close');

        this.templateManager = new TemplateManager();
        this.imageObj = new Image();

        // Bind event handlers
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Image upload
        this.imageUpload.addEventListener('change', e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = evt => {
            this.templateManager.setImageURL(evt.target.result);
            this.loadImage(evt.target.result);
          };
          reader.readAsDataURL(file);
        });

        // Create new box
        this.addBoxBtn.addEventListener('click', () => {
          this.tryAddBox();
        });

        // Save template
        this.saveTemplateBtn.addEventListener('click', () => {
          this.trySaveTemplate();
        });

        // Load templates list
        this.loadTemplatesBtn.addEventListener('click', () => this.renderTemplateList());

        // Generate text overlay on canvas
        this.generateTextBtn.addEventListener('click', ()=> this.generateTextOverlay());

        // Download canvas image
        this.downloadBtn.addEventListener('click', ()=> this.downloadImage());

        // Modal buttons
        this.confirmDeleteBtn.addEventListener('click', () => this.confirmDelete());
        this.cancelDeleteBtn.addEventListener('click', () => this.closeDeleteModal());
        this.modalCloseBtn.addEventListener('click', () => this.closeDeleteModal());
        this.deleteModal.addEventListener('click', e => {
          if (e.target === this.deleteModal) this.closeDeleteModal();
        });
        document.addEventListener('keydown', e => {
          if (e.key === "Escape" && this.deleteModal.classList.contains('show')) this.closeDeleteModal();
        });
      }

      loadImage(url) {
        this.imageObj = new Image();
        this.imageObj.crossOrigin = "anonymous"; 
        this.imageObj.onload = () => {
          this.renderTemplateArea();
          this.renderBoxes();
          this.renderInputFields();
          this.clearCanvas();
          this.showToast("Image loaded");
        };
        this.imageObj.src = url;
      }

      renderTemplateArea() {
        this.templateArea.innerHTML = '';
        this.templateArea.style.width = this.imageObj.width + 'px';
        this.templateArea.style.height = this.imageObj.height + 'px';
        this.templateArea.appendChild(this.imageObj);
      }

      renderBoxes() {
        this.templateManager.currentTemplate.boxes.forEach(box => this.createBoxElement(box));
      }

      createBoxElement(box) {
        const div = document.createElement('div');
        div.className = 'highlight-box';
        div.style.left = box.left + 'px';
        div.style.top = box.top + 'px';
        div.style.width = box.width + 'px';
        div.style.height = box.height + 'px';
        div.dataset.name = box.name;
        div.title = box.name;
        div.setAttribute('tabindex', 0);

        // Add drag handle
        const handle = document.createElement('div');
        handle.className = 'drag-handle';
        handle.textContent = '+';
        div.appendChild(handle);

        // Drag events
        handle.addEventListener('mousedown', e => this.dragStart(e, div));
        handle.addEventListener('touchstart', e => this.dragStart(e, div), {passive:false});

        // Drag box select on click
        div.addEventListener('click', e => {
          e.stopPropagation();
          this.selectBox(div);
        });

        // Update box on mouse/touch up (including after resize)
        div.addEventListener('mouseup', () => this.updateBoxFromElement(div));
        div.addEventListener('touchend', () => this.updateBoxFromElement(div));
        div.addEventListener('blur', () => this.updateBoxFromElement(div));

        // Resizable
        div.style.resize = 'both';
        div.style.overflow = 'auto';

        this.templateArea.appendChild(div);
      }

      dragStart(e, boxDiv) {
        e.preventDefault();
        this.selectBox(boxDiv);
        const isTouch = e.type === "touchstart";
        const areaRect = this.templateArea.getBoundingClientRect();

        const startX = isTouch ? e.touches[0].clientX : e.clientX;
        const startY = isTouch ? e.touches[0].clientY : e.clientY;
        const origLeft = parseFloat(boxDiv.style.left);
        const origTop = parseFloat(boxDiv.style.top);

        const onMove = ev => {
          ev.preventDefault();
          const clientX = isTouch ? ev.touches[0].clientX : ev.clientX;
          const clientY = isTouch ? ev.touches[0].clientY : ev.clientY;
          const newLeft = Math.min(Math.max(0, origLeft + clientX - startX), areaRect.width - boxDiv.offsetWidth);
          const newTop = Math.min(Math.max(0, origTop + clientY - startY), areaRect.height - boxDiv.offsetHeight);
          boxDiv.style.left = newLeft + 'px';
          boxDiv.style.top = newTop + 'px';
        };
        const onEnd = () => {
          this.updateBoxFromElement(boxDiv);
          document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onMove);
          document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onEnd);
        };
        document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onMove, {passive:false});
        document.addEventListener(isTouch ? 'touchend' : 'mouseup', onEnd, {passive:false});
      }

      selectBox(div) {
        Array.from(this.templateArea.querySelectorAll('.highlight-box')).forEach(el => el.classList.remove('selected'));
        div.classList.add('selected');
      }

      updateBoxFromElement(div) {
        const name = div.dataset.name;
        const rect = div.getBoundingClientRect();
        const parentRect = this.templateArea.getBoundingClientRect();

        const left = Math.min(Math.max(rect.left - parentRect.left, 0), this.templateArea.offsetWidth);
        const top = Math.min(Math.max(rect.top - parentRect.top, 0), this.templateArea.offsetHeight);
        const width = Math.min(rect.width, this.templateArea.offsetWidth - left);
        const height = Math.min(rect.height, this.templateArea.offsetHeight - top);
        const updatedBox = new Box(name, left, top, width, height);
        this.templateManager.updateBox(updatedBox);
        this.renderInputFields();
      }

      renderInputFields() {
        this.inputFields.innerHTML = '';
        if (!this.templateManager.currentTemplate.boxes.length) {
          this.inputFields.textContent = 'Add boxes to enter text here.';
          return;
        }
        this.templateManager.currentTemplate.boxes.forEach(box => {
          const wrapper = document.createElement('div');
          wrapper.className = 'input-wrapper';

          const label = document.createElement('label');
          label.textContent = box.name;
          label.setAttribute('for', 'input-' + box.name);

          const input = document.createElement('input');
          input.type = 'text';
          input.id = 'input-' + box.name;
          input.dataset.name = box.name;
          input.placeholder = `Enter text for "${box.name}"`;
          input.autocomplete = 'off';

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          this.inputFields.appendChild(wrapper);
        });
      }

      tryAddBox() {
        const name = this.boxNameInput.value.trim();
        if (!name) {
          this.showToast('Enter a box name');
          return;
        }
        if (this.templateManager.currentTemplate.boxes.some(b => b.name.toLowerCase() === name.toLowerCase())) {
          this.showToast('Box name already exists');
          return;
        }
        if (!this.templateManager.currentTemplate.imageURL) {
          this.showToast('Upload image first');
          return;
        }
        try {
          this.templateManager.addBox(new Box(name));
          this.createBoxElement(this.templateManager.currentTemplate.boxes.slice(-1)[0]);
          this.renderInputFields();
          this.boxNameInput.value = '';
          this.showToast('Box added');
        } catch(e) {
          this.showToast(e.message);
        }
      }

      trySaveTemplate() {
        const name = this.templateNameInput.value.trim();
        if (!name) {
          this.showToast('Enter a template name');
          return;
        }
        try {
          this.templateManager.saveTemplate(name);
          this.showToast(`Template "${name}" saved`);
          this.renderTemplateList();
        } catch(e) {
          this.showToast('Failed to save template');
        }
      }

      renderTemplateList() {
        this.templateList.innerHTML = '';
        const templates = this.templateManager.listTemplates();
        if (templates.length === 0) {
          this.templateList.textContent = 'No saved templates.';
          return;
        }
        templates.forEach(name => {
          const container = document.createElement('div');
          container.className = 'template-item';

          const label = document.createElement('span');
          label.textContent = name;

          const btnLoad = document.createElement('button');
          btnLoad.textContent = 'Load';
          btnLoad.className = 'loadBtn';
          btnLoad.title = `Load template "${name}"`;
          btnLoad.addEventListener('click', () => {
            try {
              const tpl = this.templateManager.loadTemplate(name);
              this.loadImageAndBoxes(tpl);
              this.templateNameInput.value = name;
              this.showToast(`Template "${name}" loaded`);
            } catch(e) {
              this.showToast('Failed to load template');
            }
          });

          const btnDel = document.createElement('button');
          btnDel.textContent = 'Delete';
          btnDel.className = 'delBtn';
          btnDel.title = `Delete template "${name}"`;
          btnDel.addEventListener('click', () => {
            this.showDeleteModal(`Delete template "<strong>${name}</strong>"?`, name);
          });

          container.appendChild(label);
          container.appendChild(btnLoad);
          container.appendChild(btnDel);

          this.templateList.appendChild(container);
        });
      }

      loadImageAndBoxes(template) {
        this.templateManager.currentTemplate = template;
        this.loadImage(template.imageURL);
      }

      generateTextOverlay() {
        if (!this.imageObj.src) {
          this.showToast('Upload an image first!');
          return;
        }
        if (!this.templateManager.currentTemplate.boxes.length) {
          this.showToast('Add at least one box');
          return;
        }
        this.outputCanvas.width = this.imageObj.width;
        this.outputCanvas.height = this.imageObj.height;
        this.ctx.clearRect(0, 0, this.outputCanvas.width, this.outputCanvas.height);
        this.ctx.drawImage(this.imageObj, 0, 0);

        this.templateManager.currentTemplate.boxes.forEach(box => {
          const input = this.inputFields.querySelector(`input[data-name="${box.name}"]`);
          if(!input || !input.value.trim()) return;
          const text = input.value.trim();

          this.ctx.save();
          this.ctx.fillStyle = '#222';
          this.ctx.textBaseline = 'top';

          let fontSize = 18;
          this.ctx.font = `${fontSize}px Segoe UI, Arial, sans-serif`;
          const maxWidth = box.width - 12;
          while(fontSize > 10 && this.ctx.measureText(text).width > maxWidth) {
            fontSize--;
            this.ctx.font = `${fontSize}px Segoe UI, Arial, sans-serif`;
          }
          this.ctx.fillText(text, box.left + 6, box.top + 6);
          this.ctx.restore();
        });
        this.showToast('Text generated on image');
      }

      downloadImage() {
        if(!this.outputCanvas.width || !this.outputCanvas.height) {
          this.showToast('Generate the image first');
          return;
        }
        const link = document.createElement("a");
        link.download = "template_output.png";
        link.href = this.outputCanvas.toDataURL("image/png");
        link.click();
        this.showToast('Image downloaded');
      }

      showToast(msg) {
        // Simple toast with fadeout
        if(!this._toastElem) {
          this._toastElem = document.createElement('div');
          this._toastElem.style.cssText = `
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: var(--blue); color: white; padding: 14px 30px; border-radius: 20px;
            font-weight: 600; box-shadow: 0 6px 18px var(--blue); opacity: 0; 
            transition: opacity 0.3s ease; user-select:none; z-index: 9999;
          `;
          document.body.appendChild(this._toastElem);
        }
        this._toastElem.textContent = msg;
        this._toastElem.style.opacity = '1';
        clearTimeout(this._toastTimeout);
        this._toastTimeout = setTimeout(() => {
          this._toastElem.style.opacity = '0';
        }, 1700);
      }

      showDeleteModal(htmlMsg, templateName) {
        this.modalMessage.innerHTML = htmlMsg;
        this.deleteModal.classList.add('show');
        this._deleteTarget = templateName;
        this.confirmDeleteBtn.focus();
      }
      closeDeleteModal() {
        this.deleteModal.classList.remove('show');
        this._deleteTarget = null;
      }
      confirmDelete() {
        if(this._deleteTarget) {
          this.templateManager.deleteTemplate(this._deleteTarget);
          this.closeDeleteModal();
          this.renderTemplateList();
          this.showToast('Template deleted');
        }
      }

      // Initialization
      init() {
        this.renderTemplateList();
      }
    }

    // ========== Initialize UI Controller ==========
    const ui = new UIController();
    ui.init();
  </script>
</body>
</html>
