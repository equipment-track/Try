<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rich Text Template Box Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "Segoe UI", Arial, sans-serif; background: #f2f4f9; margin: 0; }
.container { max-width: 920px; margin: 24px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px #0002; padding: 24px; }
h2 { color: #255fd3; text-align: center; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 18px; }
.controls input[type="file"], .controls input[type="text"] { padding: 10px; border-radius: 7px; border: 1px solid #bcd; }
.controls button { background: #255fd3; color: #fff; padding: 10px 18px; border-radius: 7px; border: none; cursor: pointer; font-weight: bold; }
.controls button:hover { background: #15396a; }
#previewContainer { position: relative; border: 3px solid #b3c7ec; border-radius: 12px; background: #f5f8ff; margin: 0 auto 24px; max-width: 100%; min-height: 320px; }
#templateCanvas { border-radius: 11px; max-width: 100%; box-shadow: 0 2px 18px #e7eef9; display: block; background: white; }
.box-overlay {
  position: absolute; border: 2px dashed #ffc107;
  background: rgba(255,210,7,0.08); border-radius: 9px;
  min-width: 70px; min-height: 34px; cursor: move; user-select: none; z-index: 9;
  box-sizing: border-box; display: flex; flex-direction: column; padding: 4px 2px 2px 6px;
}
.box-overlay.selected { border-color: #276ef1; box-shadow: 0 0 18px 3px #276ef133; z-index: 31; }
.resize-grip {
  position: absolute; right: -9px; bottom: -9px; width: 16px; height: 16px;
  background: #ffc107; border-radius: 50%; border: 2px solid #fff;
  cursor: nwse-resize; z-index: 9; touch-action: none;
}
.box-style-bar {
  display: flex; gap: 7px; align-items: center; margin-bottom: 1px; min-height:28px;
  padding: 0 2px 0 0;
}
.box-style-bar select, .box-style-bar button {
  font-size: 1rem; border-radius: 4px; border: 1px solid #aac4ff; background: #eaf3ff; color: #222;
  padding: 1px 7px; cursor: pointer; outline: none; height: 26px; line-height: 1.2;
}
.box-style-bar button { width: 28px; }
.box-style-bar button.active { background: #276ef1; color: #fff; }
.box-editor-text {
  flex: 1 0 0; width: 100%; min-height: 20px; background: transparent; border: none; outline: none;
  resize: none; font-family: inherit; font-size: 18px; color: #222; font-weight: 400; 
  white-space: pre-wrap; overflow-wrap: break-word; word-break: break-word; line-height: 1.26;
  caret-color: #276ef1;
  user-select: text;
}
</style>
</head>
<body>
<div class="container">
  <h2>Template Box Editor (Rich Text, Download-Ready)</h2>
  <div class="controls">
    <input type="file" accept="image/*" id="imageUpload">
    <input type="text" placeholder="New Box Name" id="boxName" autocomplete="off">
    <button id="addBoxBtn">Add Box</button>
    <button id="downloadBtn">Download Image</button>
    <button id="applyBtn">Apply To Canvas</button>
  </div>
  <div id="previewContainer">
    <canvas id="templateCanvas"></canvas>
  </div>
</div>

<script>
(function() {
  const imageUpload = document.getElementById('imageUpload');
  const boxNameInput = document.getElementById('boxName');
  const addBoxBtn = document.getElementById('addBoxBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const applyBtn = document.getElementById('applyBtn');
  const previewContainer = document.getElementById('previewContainer');
  const canvas = document.getElementById('templateCanvas');
  const ctx = canvas.getContext('2d');

  let image = new Image(), boxes = [], selectedBox = null;

  function drawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!image.src) return;
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

    boxes.forEach(box => {
      ctx.save();
      ctx.translate(box.left, box.top);
      ctx.beginPath();
      ctx.rect(0, 0, box.width, box.height);
      ctx.clip();
      let fStyle = '';
      if (box.styles.italic) fStyle += 'italic ';
      if (box.styles.bold) fStyle += 'bold ';
      const fontSize = box.styles.fontSize;
      ctx.font = `${fStyle}${fontSize}px Arial, sans-serif`;
      ctx.textBaseline = 'top';
      ctx.textAlign = 'left';
      ctx.fillStyle = '#222';
      const padding = 5, lineHeight = fontSize * 1.22;
      const lines = (box.text || '').split('\n');
      for (let i = 0; i < lines.length; i++) {
        const y = padding + i * lineHeight;
        if (y + lineHeight > box.height - padding) break;
        ctx.fillText(lines[i], padding, y, box.width - 2 * padding);
      }
      ctx.restore();
    });
  }

  function createBoxOverlays() {
    document.querySelectorAll('.box-overlay').forEach(el => el.remove());
    boxes.forEach(box => {
      const el = document.createElement('div');
      el.className = 'box-overlay' + (selectedBox && box === selectedBox ? ' selected' : '');
      el.style.left = box.left + 'px'; el.style.top = box.top + 'px';
      el.style.width = box.width + 'px'; el.style.height = box.height + 'px';
      el.tabIndex = 0;

      // Toolbar
      let styleBar = document.createElement('div');
      styleBar.className = 'box-style-bar';
      styleBar.style.display = (selectedBox === box) ? 'flex' : 'none';

      let boldBtn = document.createElement('button');
      boldBtn.innerHTML = '<b>B</b>';
      boldBtn.classList.toggle('active', box.styles.bold);
      boldBtn.onclick = () => {
        box.styles.bold = !box.styles.bold;
        boldBtn.classList.toggle('active', box.styles.bold);
        textDiv.style.fontWeight = box.styles.bold ? 'bold' : '';
      };
      let italicBtn = document.createElement('button');
      italicBtn.innerHTML = '<i>I</i>';
      italicBtn.classList.toggle('active', box.styles.italic);
      italicBtn.onclick = () => {
        box.styles.italic = !box.styles.italic;
        italicBtn.classList.toggle('active', box.styles.italic);
        textDiv.style.fontStyle = box.styles.italic ? 'italic' : '';
      };
      let sizeSel = document.createElement('select');
      [14,16,18,20,22,24,32].forEach(sz => {
        let o = document.createElement('option'); o.value=sz; o.innerText=sz+'px';
        if (sz === box.styles.fontSize) o.selected = true;
        sizeSel.appendChild(o);
      });
      sizeSel.onchange = () => {
        box.styles.fontSize = +sizeSel.value;
        textDiv.style.fontSize = sizeSel.value + 'px';
      };

      styleBar.appendChild(boldBtn);
      styleBar.appendChild(italicBtn);
      styleBar.appendChild(sizeSel);
      el.appendChild(styleBar);

      // Editable text area
      let textDiv = document.createElement('div');
      textDiv.className = 'box-editor-text';
      textDiv.contentEditable = true;
      textDiv.spellcheck = false;
      textDiv.innerText = box.text || '';
      textDiv.style.fontWeight = box.styles.bold ? 'bold' : '';
      textDiv.style.fontStyle = box.styles.italic ? 'italic' : '';
      textDiv.style.fontSize = box.styles.fontSize + 'px';
      // Remove formatting but allow newlines only
      textDiv.addEventListener('keydown', e => {
        if (e.key === "Enter") {
          document.execCommand('insertLineBreak');
          e.preventDefault();
        }
      });
      el.appendChild(textDiv);

      // Resize grip
      const grip = document.createElement('div'); grip.className = 'resize-grip';
      el.appendChild(grip);
      // Drag
      let dragging = false, startX, startY, boxStartL, boxStartT;
      el.addEventListener('mousedown', e => {
        if (e.target === grip || e.target.closest('.box-style-bar')) return;
        dragging = true;
        startX = e.clientX; startY = e.clientY;
        boxStartL = box.left; boxStartT = box.top;
        el.style.zIndex = 40;
        e.preventDefault();
      });
      window.addEventListener('mousemove', evt => {
        if (!dragging) return;
        const dx = evt.clientX - startX, dy = evt.clientY - startY;
        box.left = Math.max(0, Math.min((canvas.width || 1200) - box.width, boxStartL + dx));
        box.top = Math.max(0, Math.min((canvas.height || 800) - box.height, boxStartT + dy));
        el.style.left = box.left + 'px'; el.style.top = box.top + 'px';
        drawCanvas();
      });
      window.addEventListener('mouseup', () => { if(dragging){ dragging=false; el.style.zIndex=9;} });

      // Resize
      let resizing = false, sx, sy, bw, bh;
      grip.addEventListener('mousedown', e => {
        resizing = true; sx = e.clientX; sy = e.clientY; bw=box.width; bh=box.height;
        el.style.zIndex = 99; e.stopPropagation();
      });
      window.addEventListener('mousemove', evt => {
        if (!resizing) return;
        box.width = Math.max(70, Math.min((canvas.width || 1200) - box.left, bw + (evt.clientX - sx)));
        box.height = Math.max(34, Math.min((canvas.height || 800) - box.top, bh + (evt.clientY - sy)));
        el.style.width = box.width + 'px'; el.style.height = box.height + 'px';
        drawCanvas();
      });
      window.addEventListener('mouseup', () => { if(resizing){ resizing=false; el.style.zIndex=9;} });

      // Select/toggle style bar
      el.addEventListener('click', e => {
        if (selectedBox !== box) {
          selectedBox = box;
          document.querySelectorAll('.box-overlay .box-style-bar').forEach(bar => bar.style.display='none');
          styleBar.style.display = 'flex';
          document.querySelectorAll('.box-overlay').forEach(boxDiv => boxDiv.classList.remove('selected'));
          el.classList.add('selected');
        }
        e.stopPropagation();
      });

      previewContainer.appendChild(el);
    });
  }

  // Apply Everything to Canvas (text, styles)
  applyBtn.onclick = () => {
    document.querySelectorAll('.box-overlay').forEach((overlay, idx) => {
      const txtDiv = overlay.querySelector('.box-editor-text');
      boxes[idx].text = txtDiv ? txtDiv.innerText.trimEnd() : "";
      boxes[idx].styles.bold = !!(txtDiv && txtDiv.style.fontWeight === "bold");
      boxes[idx].styles.italic = !!(txtDiv && txtDiv.style.fontStyle === "italic");
      boxes[idx].styles.fontSize = parseInt(txtDiv && txtDiv.style.fontSize) || 18;
    });
    drawCanvas();
  };

  // Add Box
  addBoxBtn.onclick = () => {
    if (!image.src) return alert("Upload image first.");
    const name = boxNameInput.value.trim() || ("Box "+(boxes.length+1));
    boxes.push({ name, left: 70, top: 70, width: 180, height: 52,
      text: "",
      styles: { bold: false, italic: false, fontSize: 18 }
    });
    boxNameInput.value = "";
    selectedBox = boxes[boxes.length-1];
    createBoxOverlays();
    drawCanvas();
  };

  // Download
  downloadBtn.onclick = () => {
    applyBtn.click();
    setTimeout(()=>{
      canvas.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'template-image.jpg';
        a.click();
        URL.revokeObjectURL(a.href);
      }, "image/jpeg", 0.98);
    }, 120); // let browser repaint overlays
  };

  // Load Image
  imageUpload.onchange = function() {
    if (!this.files[0]) return;
    let reader = new FileReader();
    reader.onload = e => {
      image.src = e.target.result;
      image.onload = () => {
        canvas.width = image.width;
        canvas.height = image.height;
        boxes = [];
        selectedBox = null;
        createBoxOverlays();
        drawCanvas();
      };
    };
    reader.readAsDataURL(this.files[0]);
  };

  window.addEventListener('click', e => {
    if (!e.target.closest('.box-overlay')) {
      selectedBox = null;
      document.querySelectorAll('.box-overlay').forEach(r => r.classList.remove('selected'));
      document.querySelectorAll('.box-style-bar').forEach(b => b.style.display = 'none');
    }
  });

})();
</script>
</body>
</html>
